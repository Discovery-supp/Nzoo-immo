const { createClient } = require('@supabase/supabase-js');

console.log('üîç DIAGNOSTIC COMPLET - PROCESSUS DE R√âSERVATION');
console.log('================================================\n');

// Configuration Supabase
const supabaseUrl = 'https://nnkywmfxoohehtyyzzgp.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ua3l3bWZ4b29oZWh0eXl6emdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNDQ3NTcsImV4cCI6MjA2OTcyMDc1N30.VZtsHLfbVks1uLhfnjW6uJSP0-J-Z30-WWT5D_B8Jpk';

const supabase = createClient(supabaseUrl, supabaseAnonKey);

// Simuler le service SpaceDatabaseService
class MockSpaceDatabaseService {
  static async loadFromDatabase(language) {
    try {
      console.log(`üìä Chargement des espaces depuis la base de donn√©es (${language})...`);
      
      const { data, error } = await supabase
        .from('spaces_content')
        .select('*')
        .eq('language', language)
        .eq('is_active', true);

      if (error) {
        console.error('‚ùå Erreur lors du chargement:', error.message);
        return null;
      }

      if (!data || data.length === 0) {
        console.log('‚ÑπÔ∏è Aucun espace trouv√© en base de donn√©es');
        return null;
      }

      // Convertir les donn√©es de la base vers le format local
      const convertedData = data.reduce((acc, dbSpace) => {
        acc[dbSpace.space_key] = {
          title: dbSpace.title,
          description: dbSpace.description,
          features: dbSpace.features,
          dailyPrice: dbSpace.daily_price,
          monthlyPrice: dbSpace.monthly_price,
          yearlyPrice: dbSpace.yearly_price,
          hourlyPrice: dbSpace.hourly_price,
          maxOccupants: dbSpace.max_occupants,
          imageUrl: dbSpace.image_url,
          isAvailable: dbSpace.is_available !== false,
          lastModified: dbSpace.updated_at
        };
        return acc;
      }, {});

      console.log(`‚úÖ ${Object.keys(convertedData).length} espaces charg√©s depuis la base de donn√©es`);
      return convertedData;

    } catch (error) {
      console.error('‚ùå Erreur inattendue lors du chargement:', error.message);
      return null;
    }
  }
}

// Simuler le service de r√©servation
class MockReservationService {
  static async createReservation(reservationData) {
    try {
      console.log('üìù Cr√©ation de la r√©servation...');
      console.log('üìã Donn√©es de r√©servation:', reservationData);

      const { data, error } = await supabase
        .from('reservations')
        .insert(reservationData)
        .select()
        .single();

      if (error) {
        console.error('‚ùå Erreur lors de la cr√©ation de la r√©servation:', error.message);
        return { success: false, error: error.message };
      }

      console.log('‚úÖ R√©servation cr√©√©e avec succ√®s');
      console.log('üÜî ID R√©servation:', data.id);
      return { success: true, data };
    } catch (error) {
      console.error('‚ùå Erreur inattendue lors de la cr√©ation:', error.message);
      return { success: false, error: error.message };
    }
  }
}

// Test 1: V√©rifier les espaces disponibles
async function testEspacesDisponibles() {
  console.log('üß™ TEST 1: V√âRIFICATION DES ESPACES DISPONIBLES');
  console.log('===============================================\n');

  try {
    const dbSpaces = await MockSpaceDatabaseService.loadFromDatabase('fr');
    
    if (!dbSpaces) {
      console.log('‚ùå Aucun espace disponible pour les r√©servations');
      return false;
    }

    console.log('‚úÖ Espaces disponibles pour r√©servation:');
    Object.entries(dbSpaces).forEach(([key, space]) => {
      console.log(`   - ${key}: ${space.title} (${space.dailyPrice}$/jour)`);
      console.log(`     Disponible: ${space.isAvailable ? 'Oui' : 'Non'}`);
      console.log(`     Max occupants: ${space.maxOccupants}`);
    });

    return true;
  } catch (error) {
    console.error('‚ùå Erreur lors du test des espaces:', error.message);
    return false;
  }
}

// Test 2: V√©rifier la structure de la table reservations
async function testStructureReservations() {
  console.log('\nüß™ TEST 2: V√âRIFICATION DE LA STRUCTURE DE LA TABLE R√âSERVATIONS');
  console.log('==================================================================\n');

  try {
    // V√©rifier si la table existe et a des colonnes
    const { data: reservations, error } = await supabase
      .from('reservations')
      .select('*')
      .limit(1);

    if (error) {
      console.error('‚ùå Erreur lors de la v√©rification de la table reservations:', error.message);
      return false;
    }

    console.log('‚úÖ Table reservations accessible');
    
    // V√©rifier les colonnes requises
    const colonnesRequises = [
      'full_name', 'email', 'phone', 'space_type', 'start_date', 
      'end_date', 'amount', 'payment_method', 'status'
    ];

    if (reservations && reservations.length > 0) {
      const colonnes = Object.keys(reservations[0]);
      console.log('üìã Colonnes disponibles:', colonnes);
      
      const colonnesManquantes = colonnesRequises.filter(col => !colonnes.includes(col));
      if (colonnesManquantes.length > 0) {
        console.log('‚ö†Ô∏è Colonnes manquantes:', colonnesManquantes);
        return false;
      } else {
        console.log('‚úÖ Toutes les colonnes requises sont pr√©sentes');
      }
    } else {
      console.log('‚ÑπÔ∏è Table vide, mais structure accessible');
    }

    return true;
  } catch (error) {
    console.error('‚ùå Erreur lors du test de structure:', error.message);
    return false;
  }
}

// Test 3: Test de cr√©ation de r√©servation
async function testCreationReservation() {
  console.log('\nüß™ TEST 3: TEST DE CR√âATION DE R√âSERVATION');
  console.log('===========================================\n');

  try {
    const reservationData = {
      full_name: 'Test Utilisateur',
      email: 'test@example.com',
      phone: '+243840975949',
      company: 'Entreprise Test',
      activity: 'Test activit√©',
      address: '123 Rue Test, Brazzaville',
      space_type: 'coworking',
      start_date: '2024-01-25',
      end_date: '2024-01-26',
      occupants: 1,
      subscription_type: 'daily',
      amount: 25,
      payment_method: 'cash',
      transaction_id: `TEST_${Date.now()}`,
      status: 'confirmed',
      created_at: new Date().toISOString()
    };

    const result = await MockReservationService.createReservation(reservationData);
    
    if (result.success) {
      console.log('‚úÖ Test de cr√©ation de r√©servation r√©ussi');
      return true;
    } else {
      console.log('‚ùå Test de cr√©ation de r√©servation √©chou√©:', result.error);
      return false;
    }
  } catch (error) {
    console.error('‚ùå Erreur lors du test de cr√©ation:', error.message);
    return false;
  }
}

// Test 4: V√©rifier les contraintes et permissions
async function testContraintesPermissions() {
  console.log('\nüß™ TEST 4: V√âRIFICATION DES CONTRAINTES ET PERMISSIONS');
  console.log('=======================================================\n');

  try {
    // Test d'insertion avec donn√©es minimales
    const testData = {
      full_name: 'Test Minimal',
      email: 'minimal@test.com',
      phone: '+243000000000',
      space_type: 'coworking',
      start_date: '2024-01-25',
      end_date: '2024-01-26',
      amount: 25,
      payment_method: 'cash',
      status: 'pending'
    };

    const { data, error } = await supabase
      .from('reservations')
      .insert(testData)
      .select()
      .single();

    if (error) {
      console.log('‚ùå Erreur de contrainte/permission:', error.message);
      
      // Analyser l'erreur
      if (error.message.includes('violates')) {
        console.log('üîç Probl√®me de contrainte de base de donn√©es');
      } else if (error.message.includes('permission')) {
        console.log('üîç Probl√®me de permission RLS');
      } else if (error.message.includes('column')) {
        console.log('üîç Probl√®me de colonne manquante');
      }
      
      return false;
    } else {
      console.log('‚úÖ Test de contraintes r√©ussi');
      
      // Nettoyer la r√©servation de test
      await supabase
        .from('reservations')
        .delete()
        .eq('id', data.id);
      
      console.log('üßπ R√©servation de test supprim√©e');
      return true;
    }
  } catch (error) {
    console.error('‚ùå Erreur lors du test de contraintes:', error.message);
    return false;
  }
}

// Test 5: V√©rifier les RLS policies
async function testRLSPolicies() {
  console.log('\nüß™ TEST 5: V√âRIFICATION DES POLITIQUES RLS');
  console.log('==========================================\n');

  try {
    // V√©rifier les politiques RLS sur la table reservations
    const { data: policies, error } = await supabase
      .from('pg_policies')
      .select('*')
      .eq('tablename', 'reservations');

    if (error) {
      console.log('‚ö†Ô∏è Impossible de v√©rifier les politiques RLS:', error.message);
      console.log('üí° V√©rifiez manuellement les politiques dans Supabase Dashboard');
      return true; // On ne peut pas d√©terminer
    }

    if (policies && policies.length > 0) {
      console.log('‚úÖ Politiques RLS trouv√©es:');
      policies.forEach(policy => {
        console.log(`   - ${policy.policyname}: ${policy.cmd} (${policy.roles.join(', ')})`);
      });
    } else {
      console.log('‚ö†Ô∏è Aucune politique RLS trouv√©e pour la table reservations');
      console.log('üí° Cela peut causer des probl√®mes de permissions');
    }

    return true;
  } catch (error) {
    console.error('‚ùå Erreur lors du test RLS:', error.message);
    return false;
  }
}

// Test 6: V√©rifier les triggers et fonctions
async function testTriggersFunctions() {
  console.log('\nüß™ TEST 6: V√âRIFICATION DES TRIGGERS ET FONCTIONS');
  console.log('==================================================\n');

  try {
    // V√©rifier s'il y a des triggers sur la table reservations
    const { data: triggers, error } = await supabase
      .from('information_schema.triggers')
      .select('*')
      .eq('event_object_table', 'reservations');

    if (error) {
      console.log('‚ö†Ô∏è Impossible de v√©rifier les triggers:', error.message);
      return true;
    }

    if (triggers && triggers.length > 0) {
      console.log('‚úÖ Triggers trouv√©s:');
      triggers.forEach(trigger => {
        console.log(`   - ${trigger.trigger_name}: ${trigger.event_manipulation} ${trigger.action_timing}`);
      });
    } else {
      console.log('‚ÑπÔ∏è Aucun trigger trouv√© sur la table reservations');
    }

    return true;
  } catch (error) {
    console.error('‚ùå Erreur lors du test des triggers:', error.message);
    return false;
  }
}

// Ex√©cution des tests
async function runTests() {
  console.log('üöÄ D√âBUT DU DIAGNOSTIC COMPLET\n');

  const tests = [
    { name: 'Espaces Disponibles', fn: testEspacesDisponibles },
    { name: 'Structure R√©servations', fn: testStructureReservations },
    { name: 'Cr√©ation R√©servation', fn: testCreationReservation },
    { name: 'Contraintes Permissions', fn: testContraintesPermissions },
    { name: 'Politiques RLS', fn: testRLSPolicies },
    { name: 'Triggers Fonctions', fn: testTriggersFunctions }
  ];

  const results = {};

  for (const test of tests) {
    console.log(`\nüîÑ Ex√©cution du test: ${test.name}`);
    console.log('='.repeat(50));
    
    try {
      results[test.name] = await test.fn();
    } catch (error) {
      console.error(`‚ùå Erreur dans le test ${test.name}:`, error.message);
      results[test.name] = false;
    }
  }

  // R√©sum√© des r√©sultats
  console.log('\nüìã R√âSUM√â DES TESTS');
  console.log('===================');
  
  Object.entries(results).forEach(([testName, success]) => {
    console.log(`${success ? '‚úÖ' : '‚ùå'} ${testName}: ${success ? 'R√âUSSI' : '√âCHOU√â'}`);
  });

  const testsReussis = Object.values(results).filter(Boolean).length;
  const totalTests = tests.length;

  console.log(`\nüìä R√©sultat: ${testsReussis}/${totalTests} tests r√©ussis`);

  if (testsReussis === totalTests) {
    console.log('üéâ Tous les tests sont r√©ussis ! Le processus de r√©servation devrait fonctionner.');
  } else {
    console.log('‚ö†Ô∏è Certains tests ont √©chou√©. V√©rifiez les probl√®mes identifi√©s ci-dessus.');
  }

  // Recommandations
  console.log('\nüí° RECOMMANDATIONS:');
  
  if (!results['Espaces Disponibles']) {
    console.log('1. Configurez des espaces en base de donn√©es via l\'√âditeur de contenu');
  }
  
  if (!results['Structure R√©servations']) {
    console.log('2. V√©rifiez la structure de la table reservations dans Supabase');
  }
  
  if (!results['Cr√©ation R√©servation']) {
    console.log('3. V√©rifiez les permissions et contraintes de la table reservations');
  }
  
  if (!results['Contraintes Permissions']) {
    console.log('4. Configurez les politiques RLS pour la table reservations');
  }

  console.log('\nüîß PROCHAINES √âTAPES:');
  console.log('1. Corriger les probl√®mes identifi√©s ci-dessus');
  console.log('2. Red√©marrer le serveur de d√©veloppement');
  console.log('3. Tester le processus de r√©servation dans l\'application');
  console.log('4. V√©rifier les logs dans la console du navigateur (F12)');
}

runTests().catch(console.error);
